name: 50 DAST Scan Docker Image

on:
  workflow_dispatch:
    # inputs:
    #   image-tag:
    #     type: string
    #     description: 'The name of the docker image to scan'
    #     required: true

  workflow_call:
    inputs:
      image-tag:
        type: string
        description: 'The name of the docker image to scan'
        required: true

jobs:
  dast-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.CI_REGISTRY_USER }}
          password: ${{ secrets.CI_REGISTRY_PASSWORD }}

      - name: Debug Image Tag
        run: echo ${{ inputs.image-tag }}

      - name: Start Docker container
        run: docker run -d -p 8001:8001 --name container pirabanjan/buy-it-customer-service:${{ inputs.image-tag }}
        
      - name: Wait for container to start
        run: timeout 300 bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' localhost:8001)" != "200" ]]; do sleep 5; done' || false

      - name: Test container
        run: curl -s localhost:8001/echo?msg=Hello%20World!

      - name: Run ZAP OWASP full scan
        uses: zaproxy/action-full-scan@v0.4.0
        with:
          docker_name: 'owasp/zap2docker-stable'
          token: ${{ secrets.GITHUB_TOKEN }}
          target: 'http://localhost:8001'
          cmd_options: '-a -j -l WARN -z "-addoninstallall"'
          allow_issue_writing: true

      - name: Upload HTML report
        uses: actions/upload-artifact@v3
        with:
          name: DAST_Report.html
          path: report_html.html

      - name: Stop Docker container
        if: always()
        run: |
          docker stop customer && docker rm customer && docker container prune --force && docker image prune --force
